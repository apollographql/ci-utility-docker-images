name: Raise PR for Monthly Version Bump

on:
  schedule:
    - cron: '0 9 1 * *' # Run at midnight each Sunday
  workflow_dispatch: { }

jobs:
  find-all-docker-images:
    name: "Find all Docker Images"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@85e6279cec87321a52edac9c87bce653a07cf6c2
      - id: find-all-docker-images
        uses: ./.github/actions/find_all_docker_images
    outputs:
      docker_images: ${{ steps.find-all-docker-images.outputs.docker_images }}
  create-new-config-yamls:
    name: "Calculate and Store New config.yml"
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    needs: find-all-docker-images
    strategy:
      matrix:
        image_directory: ${{ fromJSON(needs.find-all-docker-images.outputs.docker_images ) }}
    steps:
      - name: "Checkout Repo"
        uses: actions/checkout@85e6279cec87321a52edac9c87bce653a07cf6c2
      - name: Extract Details From config.yml
        id: extract_from_config_yaml
        uses: ./.github/actions/extract_details_from_config
        with:
          config_yaml_path: ${{ github.workspace }}/${{ matrix.image_directory }}/config.yml
      - name: Bump Minor Version
        id: bump
        uses: cbrgm/semver-bump-action@main
        with:
          current-version: ${{ steps.extract_from_config_yaml.outputs.current_version }}
          bump-level: patch
      - name: "Calculate version to bump to"
        id: calculate-version
        run: |
          yq '.version = "${{ steps.bump.outputs.new_version }}"' ${{ github.workspace }}/${{ matrix.image_directory }}/config.yml > ${{ github.workspace }}/${{ matrix.image_directory }}_config.yml
      - name: "Store saved config.yml"
        uses: actions/upload-artifact@6027e3dd177782cd8ab9af838c04fd81a07f1d47
        with:
          name: new-version_${{ matrix.image_directory }}_config.yml
          path: ${{ github.workspace }}/${{ matrix.image_directory }}_config.yml

  raise_pull_request:
    name: "Raise Pull Request"
    runs-on: ubuntu-latest
    needs:
      - create-new-config-yamls
    steps:
      - name: "Checkout Repo"
        uses: actions/checkout@85e6279cec87321a52edac9c87bce653a07cf6c2
      - name: Get current date
        id: get-date
        run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
      - name: Download new config YAMLs
        id: download-new-config-yamls
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093
        with:
          pattern: new-version_*
      - name: Move the configs to their new location
        run: |
          sudo apt-get update
          sudo apt-get install -y mmv
          mmv -dx 'new-version_*_config.yml' '${{ github.workspace }}/#1/config.yml'
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@9b309f7eaa24cdc404c6e9e169d35ac06ca3671e
        with:
          commit-message: 'Update Patch Versions For All Images - ${{ steps.get-date.outputs.date }}'
          branch: update-patch-versions
          title: 'Update Patch Versions For All Images - ${{ steps.get-date.outputs.date }}'
          body: Automated PR to bump patch versions for all images, to ensure they don't get stale
